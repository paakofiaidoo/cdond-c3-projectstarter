---
- name: "Install Python"
  become: true
  raw: test -e /usr/bin/python3 || (apt -y update && apt install -y python) 
  changed_when: false

- name: "Update/upgrade packages"
  become: true
  raw: test -e /usr/bin/python3 || (apt -y update && apt -y upgrade) 
  changed_when: false
  
- name: "install nodejs, npm"
  become: true
  raw: test -e /usr/bin/python3 || (apt -y update && apt install -y nodejs npm) 
  changed_when: false
  
- name: "Install pm2"
  become: true
  raw: test -e /usr/bin/python3 || ( npm i -g pm2) 
  changed_when: false

# - name: Create Backend Directory
#   file:
#     path: /home/ubuntu/backend
#     state: directory

# - name: Extract artifact.tar.gz to EC2
#   unarchive:
#     src: artifact.tar.gz
#     dest: /home/ubuntu/backend

# - name: Start the app
#   become: true
#   shell: |
#     cd /home/ubuntu/backend/dist
#     npm install
#     pm2 stop default
#     pm2 start -f main.js

- name: Create app directory
  file:
    path: $HOME/web
    state: directory

- name: "Copy files to server"
  ansible.builtin.copy:
    src: "/artifact.tar.gz"
    dest: "$HOME/artifact.tar.gz"
    follow: yes

- name: "Install Dependencies"
  become: true
  shell: |
    tar -xvf artifact.tar.gz .
    rm artifact.tar.gz
    npm install

- name: "Start Server"
  become: true
  shell: |
    sudo pm2 stop default
    sudo pm2 start npm -- run start


# - name: "extract files" 
#   become: true
#   shell: |
#     ls
#     tar -xzf artifact.tar.gz .

# - name: "Start "
#   shell: | 
#     npm install
#     pm2 stop default
#     pm2 start npm -- start